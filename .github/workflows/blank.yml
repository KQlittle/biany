name: Build and release ddns

on:
  push:
    branches:
      - main

jobs:
  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ["amd64", "armv7l", "arm64"]
    steps:
      - uses: actions/checkout@v2

      - name: Install build tools and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential shc qemu-user-static

      - name: Install QEMU for aarch64
        if: ${{ matrix.arch == 'arm64' }}
        run: |
          sudo apt-get install -y qemu-system-aarch64

      - name: Install QEMU for armv7l
        if: ${{ matrix.arch == 'armv7l' }}
        run: |
          sudo apt-get install -y qemu-system-arm

      - name: Set script permission
        run: chmod +x ddns.sh

      - name: Build for x86/amd64
        if: "${{ matrix.arch == 'amd64' }}"
        run: shc ddns.sh -o ddns-linux-amd64

      - name: Build for armv7l
        if: "${{ matrix.arch == 'armv7l' }}"
        run: |
          sudo qemu-arm-static -L . -static ddns.sh -o ddns-linux-armv7l

      - name: Build for arm64
        if: "${{ matrix.arch == 'arm64' }}"
        run: |
          sudo qemu-aarch64-static -L . -static ddns.sh -o ddns-linux-arm64

      - name: Upload to release
        uses: actions/upload-artifact@v2
        with:
          name: ddns
          path: ddns-linux-*
